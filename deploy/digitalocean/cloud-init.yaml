#cloud-config
# ──────────────────────────────────────────────────────────────────────────────
# ListingAI — Cloud-Init for DigitalOcean Droplet
# Runs once on first boot. Configures the server for Docker-based deployment.
# ──────────────────────────────────────────────────────────────────────────────

# Create deploy user with sudo and docker access
# NOTE: DigitalOcean injects the SSH key for root via the Droplet ssh_keys
# parameter. The runcmd section below copies it to the deploy user.
users:
  - default
  - name: deploy
    groups: [sudo, docker]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL

# Update packages on first boot
package_update: true
package_upgrade: true

# Install required packages
packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - fail2ban
  - ufw
  - htop
  - jq
  - unattended-upgrades
  - git
  - make

# Write configuration files
write_files:
  # fail2ban jail configuration
  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime  = 3600
      findtime = 600
      maxretry = 5
      backend  = systemd

      [sshd]
      enabled  = true
      port     = 22
      filter   = sshd
      logpath  = /var/log/auth.log
      maxretry = 3
    permissions: "0644"

  # Systemd service for docker-compose
  - path: /etc/systemd/system/listingai.service
    content: |
      [Unit]
      Description=ListingAI Docker Compose Stack
      Requires=docker.service
      After=docker.service network-online.target
      Wants=network-online.target

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/listingai
      ExecStart=/usr/bin/docker compose -f docker/docker-compose.yml -f deploy/digitalocean/docker-compose.do.yml --env-file .env up -d
      ExecStop=/usr/bin/docker compose -f docker/docker-compose.yml -f deploy/digitalocean/docker-compose.do.yml down
      ExecReload=/usr/bin/docker compose -f docker/docker-compose.yml -f deploy/digitalocean/docker-compose.do.yml --env-file .env up -d --force-recreate
      TimeoutStartSec=300
      Restart=on-failure
      RestartSec=10

      [Install]
      WantedBy=multi-user.target
    permissions: "0644"

  # Automatic Docker cleanup (weekly)
  - path: /etc/cron.weekly/docker-cleanup
    content: |
      #!/bin/bash
      /usr/bin/docker system prune -af --volumes --filter "until=168h" 2>&1 | logger -t docker-cleanup
    permissions: "0755"

  # Swap file configuration (4GB for the 4GB Droplet)
  - path: /etc/sysctl.d/99-listingai.conf
    content: |
      vm.swappiness=10
      vm.overcommit_memory=1
      net.core.somaxconn=65535
      net.ipv4.tcp_max_syn_backlog=65535
    permissions: "0644"

runcmd:
  # ── Docker Compose v2 plugin (image has Docker but may lack compose) ─────
  - mkdir -p /usr/local/lib/docker/cli-plugins
  - curl -fsSL "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-$(uname -m)" -o /usr/local/lib/docker/cli-plugins/docker-compose
  - chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
  - docker compose version

  # ── Firewall (UFW) ──────────────────────────────────────────────────────
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp comment "SSH"
  - ufw allow 80/tcp comment "HTTP"
  - ufw allow 443/tcp comment "HTTPS"
  - ufw --force enable

  # ── fail2ban ─────────────────────────────────────────────────────────────
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # ── Swap (4GB) ───────────────────────────────────────────────────────────
  - fallocate -l 4G /swapfile
  - chmod 600 /swapfile
  - mkswap /swapfile
  - swapon /swapfile
  - echo '/swapfile none swap sw 0 0' >> /etc/fstab
  - sysctl -p /etc/sysctl.d/99-listingai.conf

  # ── Copy SSH key from root to deploy user ────────────────────────────
  - mkdir -p /home/deploy/.ssh
  - cp /root/.ssh/authorized_keys /home/deploy/.ssh/authorized_keys
  - chown -R deploy:deploy /home/deploy/.ssh
  - chmod 700 /home/deploy/.ssh
  - chmod 600 /home/deploy/.ssh/authorized_keys

  # ── Clone repository ────────────────────────────────────────────────────
  - git clone --branch ${github_branch} ${github_repo} /opt/listingai
  - chown -R deploy:deploy /opt/listingai

  # ── Create data directories ─────────────────────────────────────────────
  - mkdir -p /opt/listingai-data/{backups,nginx-ssl,certbot-webroot}
  - chown -R deploy:deploy /opt/listingai-data

  # ── Enable the systemd service (but don't start — deploy.sh handles it)
  - systemctl daemon-reload
  - systemctl enable listingai.service

  # ── Automatic security updates ──────────────────────────────────────────
  - dpkg-reconfigure -f noninteractive unattended-upgrades

  # ── Signal that cloud-init is done ──────────────────────────────────────
  - touch /opt/listingai-data/.cloud-init-complete
  - echo "ListingAI cloud-init complete at $(date)" >> /var/log/listingai-init.log
